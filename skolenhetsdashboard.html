<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Skolenhetsdashboard f√∂r rektorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles/betygkolada.css">
  <style>
    body {
      background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%);
      min-height: 100vh;
      padding: 2rem 1rem;
    }
    
    #pageTitle {
      color: white;
      text-align: center;
      font-size: 2.5rem;
      margin-bottom: 2rem;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .kpi-selector {
      background: white;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 1.5rem;
    }
    
    .selector-row {
      display: flex;
      gap: 1.5rem;
      flex-wrap: wrap;
    }
    
    .selector-group {
      flex: 1;
      min-width: 250px;
    }
    
    .selector-group label {
      display: block;
      font-weight: 600;
      color: #1e40af;
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
    }
    
    .selector-group select {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 1rem;
      transition: all 0.2s;
      background: white;
    }
    
    .selector-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .selector-group select:disabled {
      background: #f1f5f9;
      cursor: not-allowed;
    }
    
    .filter-buttons {
      display: flex;
      gap: 0.75rem;
      margin-top: 1rem;
      flex-wrap: wrap;
    }
    
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 2px solid #e2e8f0;
      background: white;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #64748b;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .filter-btn:hover {
      border-color: #667eea;
      color: #667eea;
    }
    
    .filter-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }
    
    .back-link {
      display: inline-block;
      color: white;
      text-decoration: none;
      margin-bottom: 1.5rem;
      padding: 0.5rem 1rem;
      background: rgba(255,255,255,0.2);
      border-radius: 8px;
      transition: all 0.2s;
      font-weight: 500;
    }
    
    .back-link:hover {
      background: rgba(255,255,255,0.3);
      transform: translateX(-2px);
    }
    
    .dashboard-section {
      background: white;
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .dashboard-section:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 12px rgba(0,0,0,0.15);
    }
    
    .dashboard-section h2 {
      color: #1e40af;
      font-size: 1.75rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      border-bottom: 3px solid #667eea;
      padding-bottom: 0.75rem;
    }
    
    .panel-description {
      color: #64748b;
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
      line-height: 1.6;
      background: #f8fafc;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.25rem;
      margin-top: 1.5rem;
    }
    
    .kpi-item {
      background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
      padding: 1.5rem;
      border-radius: 10px;
      border: 2px solid #e2e8f0;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .kpi-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .kpi-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
      transform: translateY(-2px);
    }
    
    .kpi-item:hover::before {
      opacity: 1;
    }
    
    .kpi-label {
      font-size: 0.9rem;
      color: #64748b;
      margin-bottom: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .kpi-value {
      font-size: 2.25rem;
      font-weight: bold;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 0.75rem;
      line-height: 1.2;
    }
    
    .kpi-trend {
      font-size: 0.9rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      border-radius: 6px;
      background: #f8fafc;
    }
    
    .trend-improving {
      color: #16a34a;
      font-weight: 600;
      background: #f0fdf4;
    }
    
    .trend-improving::before {
      content: '‚ñ≤';
      font-size: 1.1rem;
      margin-right: 0.25rem;
    }
    
    .trend-declining {
      color: #dc2626;
      font-weight: 600;
      background: #fef2f2;
    }
    
    .trend-declining::before {
      content: '‚ñº';
      font-size: 1.1rem;
      margin-right: 0.25rem;
    }
    
    .trend-stable {
      color: #64748b;
      font-weight: 600;
      background: #f8fafc;
    }
    
    .trend-stable::before {
      content: '‚óè';
      font-size: 0.8rem;
      margin-right: 0.25rem;
      opacity: 0.6;
    }
    
    .kpi-analysis {
      font-size: 0.85rem;
      color: #64748b;
      line-height: 1.5;
    }
    
    .panel-interpretation {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      padding: 1.5rem;
      border-radius: 10px;
      border: 2px solid #93c5fd;
      margin-top: 1.5rem;
    }
    
    .panel-interpretation h4 {
      color: #1e40af;
      margin-bottom: 1rem;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .panel-interpretation h4::before {
      content: 'üí°';
      font-size: 1.5rem;
    }
    
    .panel-interpretation p {
      color: #475569;
      line-height: 1.8;
      margin: 0.75rem 0;
      padding: 0.75rem;
      background: white;
      border-radius: 6px;
      border-left: 4px solid #667eea;
    }
    
    .loading-message {
      text-align: center;
      padding: 4rem 2rem;
      color: #64748b;
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .loading-message::after {
      content: '...';
      animation: loading 1.5s infinite;
    }
    
    @keyframes loading {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }
    
    @media (max-width: 768px) {
      body {
        padding: 1rem 0.5rem;
      }
      
      #pageTitle {
        font-size: 1.75rem;
      }
      
      .dashboard-section {
        padding: 1.25rem;
      }
      
      .kpi-grid {
        grid-template-columns: 1fr;
      }
      
      .selector-row {
        flex-direction: column;
      }
    }
  </style>
</head>
<body data-skoltyp="grundskola">
  <h1 id="pageTitle">Skolenhetsdashboard f√∂r rektorer</h1>

  <div class="kpi-selector">
    <div class="selector-row">
      <div class="selector-group">
        <label for="kommunSelect">V√§lj kommun:</label>
        <select id="kommunSelect"></select>
      </div>
      <div class="selector-group">
        <label for="skolenhetSelect">V√§lj skolenhet:</label>
        <select id="skolenhetSelect" disabled>
          <option value="">H√§mtar skolenheter...</option>
        </select>
      </div>
    </div>
    <div class="filter-buttons">
      <button class="filter-btn" id="filterF6" data-filter="f6">D√∂lj F-6</button>
      <button class="filter-btn" id="filter79" data-filter="79">D√∂lj √•k 7-9</button>
    </div>
  </div>

  <a href="index.html" class="back-link">‚Üê Till startsidan</a>

  <div id="stageDetection"></div>

  <!-- Dashboard content rendered below -->

  <div id="dashboardContent">
    <!-- F√∂ruts√§ttningar Section -->
    <div class="dashboard-section">
      <h2>F√∂ruts√§ttningar</h2>
      <div class="kpi-grid" id="baselineKPIs"></div>
    </div>

    <!-- Resultat Section -->
    <div class="dashboard-section">
      <h2>Resultat</h2>
      <div class="kpi-grid" id="outcomeKPIs"></div>
    </div>

    <!-- SALSA Section -->
    <div class="dashboard-section">
      <h2>SALSA/Resultat givet f√∂ruts√§ttningar</h2>
      <p class="panel-description">SALSA visar skolans resultat i relation till elevf√∂ruts√§ttningar ‚Äì en positiv avvikelse betyder att skolan presterar √∂ver f√∂rv√§ntan, en negativ att resultaten ligger under f√∂rv√§ntan.</p>
      <div class="kpi-grid" id="salsaKPIs"></div>
    </div>

    <!-- Trygghet Section -->
    <div class="dashboard-section">
      <h2>Trygghet √•k 5</h2>
      <div class="kpi-grid" id="trygghetsKPIs"></div>
    </div>

    <!-- Automatisk Analys Section -->
    <div class="dashboard-section">
      <h2>Automatisk analys</h2>
      <div class="panel-interpretation" id="analysisText">
        <h4>Analys</h4>
        <p>Automatisk analys av nyckeltal visas h√§r...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { ALLA_KOMMUNER } from './scripts/kommuner.js';
    import { SKOLENHET_SEARCH_API, SKOLENHET_DATA_BASE } from './scripts/constants.js';
    import { hamtaKoladaData } from './scripts/chartHelpers.js';

    // --- UI helpers ---
    function addKPICard(sectionId, kpi) {
      const section = document.getElementById(sectionId);
      const card = document.createElement('div');
      card.className = 'kpi-item';
      const label = document.createElement('div'); label.className = 'kpi-label'; label.textContent = kpi.label;
      const value = document.createElement('div'); value.className = 'kpi-value'; value.textContent = `${kpi.value ?? '‚Äî'} ${kpi.unit || ''}`.trim();
      const trend = document.createElement('div'); trend.className = `kpi-trend trend-${kpi.trendDirection}`; trend.textContent = kpi.trendText;
      const analysis = document.createElement('div'); analysis.className = 'kpi-analysis'; analysis.textContent = kpi.analysis;
      card.append(label, value, trend, analysis);
      section.appendChild(card);
    }
    function setLoading(sectionId, loading = true) {
      const el = document.getElementById(sectionId);
      if (el) el.innerHTML = loading ? '<div class="loading-message">Laddar...</div>' : '';
    }

    // --- Data helpers ---
    async function hamtaSkolenheterForKommun(kommunId) {
      let url = `${SKOLENHET_SEARCH_API}?municipality=${kommunId}&per_page=500`;
      const enheter = [];
      while (url) {
        const response = await fetch(url, { headers: { Accept: 'application/json' } });
        if (!response.ok) break;
        const data = await response.json();
        const resultat = data.results || data.values || [];
        resultat.forEach(enhet => {
          enheter.push({ id: enhet.id, title: enhet.title, type: (enhet.type || enhet.type_name || '').toLowerCase() });
        });
        url = data.next_page || data.next || null;
      }
      enheter.sort((a, b) => a.title.localeCompare(b.title, 'sv'));
      return enheter;
    }
    const kpiDefsBaseline = () => ([
      { id: 'N11805', label: 'Antal elever i f√∂rskoleklass', unit: 'st' },
      { id: 'N15807', label: 'Antal elever √•k 1‚Äì9', unit: 'st' },
      { id: 'N15034', label: 'Elever per l√§rare (heltidstj√§nst), kommunal grundskola √•k 1‚Äì9', unit: 'st' },
      { id: 'N15813', label: 'Andel legitimerade/beh√∂riga l√§rare √•k 1‚Äì9', unit: '%' },
      { id: 'N15031', label: 'L√§rare med pedagogisk h√∂gskoleexamen i kommunal grundskola √•k 1‚Äì9', unit: '%' }
    ]);
    const kpiDefsOutcome = () => {
      const allKpis = [
        // F-6
        { id: 'N15482', label: '√Ök 6: Engelska minst E', unit: '%', stage: 'f6' },
        { id: 'N15485', label: '√Ök 6: Matematik minst E', unit: '%', stage: 'f6' },
        { id: 'N15488', label: '√Ök 6: Svenska minst E', unit: '%', stage: 'f6' },
        { id: 'N15509', label: '√Ök 6: Betygspo√§ng i matematik', unit: 'po√§ng', stage: 'f6' },
        { id: 'N15510', label: '√Ök 6: Betygspo√§ng i svenska', unit: 'po√§ng', stage: 'f6' },
        // 7-9
        { id: 'N15419', label: '√Ök 9: Alla √§mnen godk√§nda', unit: '%', stage: '79' },
        { id: 'N15436', label: '√Ök 9: Beh√∂riga till yrkesprogram', unit: '%', stage: '79' },
        { id: 'N15505', label: '√Ök 9: Meritv√§rde (17 √§mnen)', unit: 'po√§ng', stage: '79' },
        { id: 'N15503', label: '√Ök 9: Betygspo√§ng matematik', unit: 'po√§ng', stage: '79' },
        { id: 'U15429', label: '√Ök 9: H√∂gre slutbetyg √§n NP i matematik', unit: '%', stage: '79' },
        { id: 'U15430', label: '√Ök 9: L√§gre slutbetyg √§n NP i matematik', unit: '%', stage: '79' },
        { id: 'U15431', label: '√Ök 9: H√∂gre slutbetyg √§n NP i engelska', unit: '%', stage: '79' },
        { id: 'U15432', label: '√Ök 9: L√§gre slutbetyg √§n NP i engelska', unit: '%', stage: '79' },
        { id: 'U15433', label: '√Ök 9: H√∂gre slutbetyg √§n NP i svenska', unit: '%', stage: '79' },
        { id: 'U15434', label: '√Ök 9: L√§gre slutbetyg √§n NP i svenska', unit: '%', stage: '79' }
      ];
      
      return allKpis.filter(kpi => {
        if (filterState.hideF6 && kpi.stage === 'f6') return false;
        if (filterState.hide79 && kpi.stage === '79') return false;
        return true;
      });
    };
    const kpiDefsSalsa = () => ([
      { id: 'U15413', label: '√Ök 9: SALSA modellber√§knad andel alla √§mnen', unit: '%' },
      { id: 'U15414', label: '√Ök 9: Avvikelse SALSA (%)', unit: 'p.p.' },
      { id: 'U15415', label: '√Ök 9: SALSA modellber√§knat meritv√§rde', unit: 'po√§ng' },
      { id: 'U15416', label: '√Ök 9: Meritv√§rde avvikelse (SALSA)', unit: 'po√§ng' }
    ]);
    const kpiDefsTrygghet = () => ([
      { id: 'N15613', label: '√Ök 5: Trygghet', unit: '%' },
      { id: 'N15603', label: '√Ök 5: Studiero', unit: '%' },
      { id: 'N15614', label: '√Ök 5: Vuxnas agerande mot kr√§nkningar', unit: '%' }
    ]);

    function beraknaTrendtext(unit, values) {
      const serie = (values || []).filter(v => v != null);
      if (serie.length === 0) return { dir: 'stable', arrow: '‚Üí', text: 'Ingen data', analysis: 'Data saknas.', latest: null, diff1: null, diff3: null };
      const latest = serie[serie.length - 1];
      const prev = serie[serie.length - 2] ?? null;
      const idxMinus3 = serie.length - 4; const prev3 = idxMinus3 >= 0 ? serie[idxMinus3] : null;
      const unitSuffix = unit === '%' ? 'p.p.' : unit || '';
      let dir = 'stable', arrow = '‚Üí', text = 'Stabil';
      let diff1 = null, diff3 = null;
      if (prev !== null) { diff1 = latest - prev; if (diff1 > 0.05) { dir='improving'; arrow='‚Üë'; } else if (diff1 < -0.05) { dir='declining'; arrow='‚Üì'; } }
      if (prev3 !== null) { diff3 = latest - prev3; const sign = diff3 > 0 ? '+' : ''; text = `${sign}${diff3.toFixed(1)} ${unitSuffix} p√• 3 √•r`; }
      else if (prev !== null) { const sign = diff1 > 0 ? '+' : ''; text = `${sign}${diff1.toFixed(1)} ${unitSuffix} p√• 1 √•r`; }
      else { text = 'Ingen trenddata'; }
      const analysis = dir === 'improving' ? 'F√∂rb√§ttring √∂ver tid.' : dir === 'declining' ? 'F√∂rs√§mring √∂ver tid.' : 'Stabil niv√•.';
      return { dir, arrow, text, analysis, latest, diff1, diff3 };
    }
    async function hamtaKpiCardData(ouId, def) {
      try {
        const data = await hamtaKoladaData(ouId, def.id, SKOLENHET_DATA_BASE);
        const hasAny = (data?.totalt || []).some(v => v != null);
        if (!hasAny) return { label: def.label, value: '‚Äî', unit: def.unit, trendDirection: 'stable', trendArrow: '‚Üí', trendText: 'Ingen data', analysis: 'Data saknas f√∂r denna indikator.', trendData: { dir: null, latest: null, diff1: null, diff3: null } };
        const trend = beraknaTrendtext(def.unit, data.totalt);
        return { label: def.label, value: trend.latest != null ? (def.unit === '%' ? Number(trend.latest).toFixed(1) : trend.latest) : '‚Äî', unit: def.unit, trendDirection: trend.dir, trendArrow: trend.arrow, trendText: trend.text, analysis: trend.analysis, trendData: { dir: trend.dir, latest: trend.latest, diff1: trend.diff1, diff3: trend.diff3 } };
      } catch (e) {
        console.warn('KPI fetch failed', def.id, e);
        return { label: def.label, value: '‚Äî', unit: def.unit, trendDirection: 'stable', trendArrow: '‚Üí', trendText: 'Kunde inte h√§mta', analysis: 'Kunde inte h√§mta data just nu.', trendData: { dir: null, latest: null, diff1: null, diff3: null } };
      }
    }

    // --- Analysis generation ---
    function genereraAutomatiskAnalys(kpiData) {
      const insights = [];
      
      // R1: Belastning (N15807, N15034)
      const elevantal = kpiData['N15807'];
      const elevPerLarare = kpiData['N15034'];
      if (elevantal?.dir && elevPerLarare?.dir) {
        if (elevantal.dir === 'improving' && elevPerLarare.dir === 'improving') {
          insights.push('üìä <strong>Belastningen √∂kar.</strong> Risk f√∂r st√∂rre grupper och mindre st√∂d per elev.');
        } else if (elevantal.dir === 'declining' && (elevPerLarare.dir === 'declining' || elevPerLarare.dir === 'stable')) {
          insights.push('üìä <strong>Minskad volym utan s√§mre t√§thet.</strong> L√§ge att se √∂ver organisation/resursf√∂rdelning.');
        } else if (elevantal.dir === 'stable' && elevPerLarare.dir === 'declining') {
          insights.push('üìä <strong>T√§theten f√∂rb√§ttras.</strong> Ger b√§ttre f√∂ruts√§ttningar f√∂r st√∂d/arbetsro.');
        }
      }
      
      // R2: Beh√∂righet (N15813)
      const behoriga = kpiData['N15813'];
      if (behoriga?.dir === 'improving' && behoriga.diff3 && behoriga.diff3 > 2) {
        insights.push('üë®‚Äçüè´ <strong>Beh√∂righeten f√∂rb√§ttras,</strong> vilket st√§rker f√∂ruts√§ttningarna f√∂r resultat √∂ver tid.');
      } else if (behoriga?.latest && behoriga.latest < 85) {
        insights.push('üë®‚Äçüè´ <strong>Beh√∂righeten √§r l√•g.</strong> Kompetensf√∂rs√∂rjning b√∂r prioriteras.');
      }
      
      // R3: √Ñmnesspecifikt vs brett (F-6: N15482, N15485, N15488)
      const engelska = kpiData['N15482'];
      const matteF6 = kpiData['N15485'];
      const svenska = kpiData['N15488'];
      const amnenF6 = [
        { name: 'engelska', data: engelska },
        { name: 'matematik', data: matteF6 },
        { name: 'svenska', data: svenska }
      ].filter(a => a.data?.dir);
      const amnenNer = amnenF6.filter(a => a.data.dir === 'declining');
      
      if (amnenNer.length === 1) {
        insights.push(`üìö <strong>Tapp i ${amnenNer[0].name} √•k 6</strong> tyder p√• √§mnesspecifik utmaning. Riktad didaktisk insats d√§r.`);
      } else if (amnenNer.length >= 2) {
        insights.push('üìö <strong>Brett tapp i flera √§mnen √•k 6.</strong> Tyder p√• systemisk fr√•ga (progression, st√∂d, studiero).');
      }
      
      // R4: E-andel vs betygspo√§ng
      const mattePoangF6 = kpiData['N15509'];
      const svePoangF6 = kpiData['N15510'];
      if (matteF6?.dir === 'stable' && mattePoangF6?.dir === 'declining') {
        insights.push('üìâ <strong>Matematik √•k 6:</strong> Fler klarar E men betygspo√§ng sjunker. Fokus p√• progression mot C/A.');
      } else if (matteF6?.dir === 'declining' && mattePoangF6?.dir === 'declining') {
        insights.push('üìâ <strong>Matematik √•k 6:</strong> Kunskapstapp p√• bredd och djup. Prioritera tidiga insatser och undervisningskvalitet.');
      }
      if (svenska?.dir === 'stable' && svePoangF6?.dir === 'declining') {
        insights.push('üìâ <strong>Svenska √•k 6:</strong> Fler klarar E men betygspo√§ng sjunker. Fokus p√• progression mot C/A.');
      } else if (svenska?.dir === 'declining' && svePoangF6?.dir === 'declining') {
        insights.push('üìâ <strong>Svenska √•k 6:</strong> Kunskapstapp p√• bredd och djup. Prioritera tidiga insatser och undervisningskvalitet.');
      }
      
      // R5: Studiero som f√∂rklarare
      const studiero = kpiData['N15603'];
      if (amnenNer.length >= 2 && studiero?.dir === 'declining') {
        insights.push('üîá <strong>Resultattapp sammanfaller med s√§mre studiero.</strong> Klassrumsledarskap/arbetsro √§r trolig h√§vst√•ng.');
      }
      
      // R6: Trygghet/f√∂rtroende
      const trygghet = kpiData['N15613'];
      const vuxnaAgerande = kpiData['N15614'];
      if (trygghet?.dir === 'declining') {
        insights.push('‚ö†Ô∏è <strong>Minskad trygghet</strong> kan p√•verka b√•de l√§rande och n√§rvaro. Se √∂ver rastmilj√∂/relationsarbete.');
      }
      if (vuxnaAgerande?.dir === 'declining') {
        insights.push('‚ö†Ô∏è <strong>F√∂rtroendet f√∂r vuxnas agerande sjunker.</strong> Beh√∂ver tydligare rutiner och synligt ledarskap.');
      }
      
      // R7: SALSA-f√∂rv√§ntning vs faktiskt
      const salsaForvantat = kpiData['U15413'];
      const faktisktAllaAmnen = kpiData['N15419'];
      const salsaAvvikelse = kpiData['U15414'];
      const salsaMeritForvantat = kpiData['U15415'];
      const faktisktMerit = kpiData['N15505'];
      const salsaMeritAvvikelse = kpiData['U15416'];
      
      // Andel alla √§mnen godk√§nda
      if (salsaForvantat?.latest && faktisktAllaAmnen?.latest && salsaAvvikelse?.latest) {
        if (salsaAvvikelse.latest > 5) {
          insights.push(`üìà <strong>Presterar tydligt √∂ver SALSA-modellen.</strong> Faktiskt ${faktisktAllaAmnen.latest.toFixed(1)}% j√§mf√∂rt med f√∂rv√§ntat ${salsaForvantat.latest.toFixed(1)}% (+${salsaAvvikelse.latest.toFixed(1)} p.p.). Skolan skapar merv√§rde givet elevernas f√∂ruts√§ttningar.`);
        } else if (salsaAvvikelse.latest > 2) {
          insights.push(`üìà <strong>Presterar √∂ver SALSA-modellen.</strong> Faktiskt ${faktisktAllaAmnen.latest.toFixed(1)}% j√§mf√∂rt med f√∂rv√§ntat ${salsaForvantat.latest.toFixed(1)}% (+${salsaAvvikelse.latest.toFixed(1)} p.p.).`);
        } else if (salsaAvvikelse.latest < -5) {
          insights.push(`üìâ <strong>Presterar tydligt under SALSA-modellen.</strong> Faktiskt ${faktisktAllaAmnen.latest.toFixed(1)}% j√§mf√∂rt med f√∂rv√§ntat ${salsaForvantat.latest.toFixed(1)}% (${salsaAvvikelse.latest.toFixed(1)} p.p.). Beh√∂ver prioritera kvalitetsutveckling.`);
        } else if (salsaAvvikelse.latest < -2) {
          insights.push(`üìâ <strong>Presterar under SALSA-modellen.</strong> Faktiskt ${faktisktAllaAmnen.latest.toFixed(1)}% j√§mf√∂rt med f√∂rv√§ntat ${salsaForvantat.latest.toFixed(1)}% (${salsaAvvikelse.latest.toFixed(1)} p.p.).`);
        }
      }
      
      // Meritv√§rde
      if (salsaMeritForvantat?.latest && faktisktMerit?.latest && salsaMeritAvvikelse?.latest) {
        if (salsaMeritAvvikelse.latest > 10) {
          insights.push(`üìà <strong>Meritv√§rde √∂ver f√∂rv√§ntat.</strong> Faktiskt ${faktisktMerit.latest.toFixed(1)} po√§ng j√§mf√∂rt med f√∂rv√§ntat ${salsaMeritForvantat.latest.toFixed(1)} po√§ng (+${salsaMeritAvvikelse.latest.toFixed(1)} po√§ng).`);
        } else if (salsaMeritAvvikelse.latest < -10) {
          insights.push(`üìâ <strong>Meritv√§rde under f√∂rv√§ntat.</strong> Faktiskt ${faktisktMerit.latest.toFixed(1)} po√§ng j√§mf√∂rt med f√∂rv√§ntat ${salsaMeritForvantat.latest.toFixed(1)} po√§ng (${salsaMeritAvvikelse.latest.toFixed(1)} po√§ng).`);
        }
      }
      
      // SALSA-trend
      if (salsaAvvikelse?.dir === 'declining' && salsaAvvikelse.diff3 && salsaAvvikelse.diff3 < -3) {
        insights.push('‚ö†Ô∏è <strong>SALSA-avvikelsen f√∂rs√§mras √∂ver tid.</strong> Skolan tappar i f√∂rh√•llande till f√∂ruts√§ttningarna.');
      } else if (salsaAvvikelse?.dir === 'improving' && salsaAvvikelse.diff3 && salsaAvvikelse.diff3 > 3) {
        insights.push('‚úÖ <strong>SALSA-avvikelsen f√∂rb√§ttras √∂ver tid.</strong> Skolan √∂kar sitt merv√§rde.');
      }
      
      // R8: NP-gap bed√∂mning
      const matteHogreNP = kpiData['U15429'];
      const matteLagreNP = kpiData['U15430'];
      const engHogreNP = kpiData['U15431'];
      const engLagreNP = kpiData['U15432'];
      const sveHogreNP = kpiData['U15433'];
      const sveLagreNP = kpiData['U15434'];
      
      if (matteHogreNP?.latest && matteHogreNP.latest > 15 && matteF6?.dir === 'declining') {
        insights.push('‚öñÔ∏è <strong>Matematik:</strong> H√∂g andel h√∂gre slutbetyg √§n NP + fallande resultat ‚Üí risk f√∂r glapp i bed√∂mning/NP-matchning.');
      }
      if (matteLagreNP?.latest && matteLagreNP.latest > 15) {
        insights.push('‚öñÔ∏è <strong>Matematik:</strong> H√∂g andel l√§gre slutbetyg √§n NP ‚Üí elever presterar p√• prov men tappar √∂ver tid.');
      }
      if (engHogreNP?.latest && engHogreNP.latest > 15 && engelska?.dir === 'declining') {
        insights.push('‚öñÔ∏è <strong>Engelska:</strong> H√∂g andel h√∂gre slutbetyg √§n NP + fallande resultat ‚Üí risk f√∂r glapp i bed√∂mning/NP-matchning.');
      }
      if (engLagreNP?.latest && engLagreNP.latest > 15) {
        insights.push('‚öñÔ∏è <strong>Engelska:</strong> H√∂g andel l√§gre slutbetyg √§n NP ‚Üí elever presterar p√• prov men tappar √∂ver tid.');
      }
      if (sveHogreNP?.latest && sveHogreNP.latest > 15 && svenska?.dir === 'declining') {
        insights.push('‚öñÔ∏è <strong>Svenska:</strong> H√∂g andel h√∂gre slutbetyg √§n NP + fallande resultat ‚Üí risk f√∂r glapp i bed√∂mning/NP-matchning.');
      }
      if (sveLagreNP?.latest && sveLagreNP.latest > 15) {
        insights.push('‚öñÔ∏è <strong>Svenska:</strong> H√∂g andel l√§gre slutbetyg √§n NP ‚Üí elever presterar p√• prov men tappar √∂ver tid.');
      }
      
      // Data-saknas fallback
      const harSaknad = Object.values(kpiData).some(k => k?.latest === null);
      if (harSaknad) {
        insights.push('<em>OBS: Vissa indikatorer saknar OU-data f√∂r denna enhet och ing√•r d√§rf√∂r inte i bed√∂mningen.</em>');
      }
      
      // Kohorteffekt (placeholder - kan ut√∂kas med faktiskt n-v√§rde senare)
      const elevantalValue = elevantal?.latest;
      if (elevantalValue && elevantalValue < 50) {
        insights.push('<em>Liten elevgrupp ‚Üí resultat kan variera mycket mellan √•r.</em>');
      }
      
      return insights.length > 0 ? insights : ['Ingen automatisk analys kunde genereras baserat p√• tillg√§nglig data.'];
    }

    // --- Rendering ---
    async function renderSections(ouId) {
      const kpiData = {};
      
      // Baseline
      setLoading('baselineKPIs', true); document.getElementById('baselineKPIs').innerHTML = '';
      for (const def of kpiDefsBaseline()) { 
        const card = await hamtaKpiCardData(ouId, def); 
        addKPICard('baselineKPIs', card);
        kpiData[def.id] = card.trendData;
      }
      
      // Outcome (both F-6 and 7-9)
      setLoading('outcomeKPIs', true); document.getElementById('outcomeKPIs').innerHTML = '';
      for (const def of kpiDefsOutcome()) { 
        const card = await hamtaKpiCardData(ouId, def); 
        addKPICard('outcomeKPIs', card);
        kpiData[def.id] = card.trendData;
      }
      
      // SALSA
      setLoading('salsaKPIs', true); document.getElementById('salsaKPIs').innerHTML = '';
      for (const def of kpiDefsSalsa()) { 
        const card = await hamtaKpiCardData(ouId, def); 
        addKPICard('salsaKPIs', card);
        kpiData[def.id] = card.trendData;
      }
      
      // Trygghet
      setLoading('trygghetsKPIs', true); document.getElementById('trygghetsKPIs').innerHTML = '';
      for (const def of kpiDefsTrygghet()) { 
        const card = await hamtaKpiCardData(ouId, def); 
        addKPICard('trygghetsKPIs', card);
        kpiData[def.id] = card.trendData;
      }
      
      // Automatisk analys
      const insights = genereraAutomatiskAnalys(kpiData);
      const analysisEl = document.getElementById('analysisText');
      analysisEl.innerHTML = '<h4>Automatisk analys</h4>' + insights.map(i => `<p>${i}</p>`).join('');
    }

    // --- Filter state ---
    const filterState = { hideF6: false, hide79: false };
    
    // --- Selectors init ---
    const kommunSelect = document.getElementById('kommunSelect');
    const skolenhetSelect = document.getElementById('skolenhetSelect');
    const filterF6Btn = document.getElementById('filterF6');
    const filter79Btn = document.getElementById('filter79');
    function initKommuner(defaultId = '0684') {
      kommunSelect.innerHTML = '';
      ALLA_KOMMUNER.forEach(k => { const opt = document.createElement('option'); opt.value=k.id; opt.textContent=k.title; if (k.id===defaultId) opt.selected=true; kommunSelect.appendChild(opt); });
    }
    async function onKommunChange() {
      skolenhetSelect.disabled = true; skolenhetSelect.innerHTML = '<option>H√§mtar skolenheter...</option>';
      const enheter = await hamtaSkolenheterForKommun(kommunSelect.value);
      skolenhetSelect.innerHTML = '';
      const def = document.createElement('option'); def.value=''; def.textContent='V√§lj skolenhet'; skolenhetSelect.appendChild(def);
      enheter.forEach(e => { const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; skolenhetSelect.appendChild(o); });
      skolenhetSelect.disabled = false;
      // Clear sections when kommun changes
      ['baselineKPIs','outcomeKPIs','salsaKPIs','trygghetsKPIs'].forEach(id => document.getElementById(id).innerHTML='');
    }
    function onSkolenhetChange() {
      const ouId = skolenhetSelect.value; if (!ouId) return; renderSections(ouId);
    }
    kommunSelect.addEventListener('change', onKommunChange);
    skolenhetSelect.addEventListener('change', onSkolenhetChange);
    
    // Filter button handlers
    filterF6Btn.addEventListener('click', () => {
      filterState.hideF6 = !filterState.hideF6;
      filterF6Btn.classList.toggle('active', filterState.hideF6);
      const ouId = skolenhetSelect.value;
      if (ouId) renderSections(ouId);
    });
    
    filter79Btn.addEventListener('click', () => {
      filterState.hide79 = !filterState.hide79;
      filter79Btn.classList.toggle('active', filterState.hide79);
      const ouId = skolenhetSelect.value;
      if (ouId) renderSections(ouId);
    });
    
    // Init
    initKommuner(); onKommunChange();
  </script>
</body>
</html>