<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Skolenhetsdashboard för rektorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="styles/betygkolada.css">
  <style>
    .dashboard-panels {
      display: grid;
      gap: 1.5rem;
      margin-top: 2rem;
    }
    .panel {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: 0 0 10px #ccc;
      border-left: 4px solid #2563eb;
    }
    .panel h2 {
      color: #1e40af;
      margin-bottom: 1rem;
      font-size: 1.3rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .panel-description {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      font-style: italic;
    }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }
    .kpi-item {
      background: #f8fafc;
      padding: 1rem;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }
    .kpi-label {
      font-size: 0.85rem;
      color: #64748b;
      margin-bottom: 0.5rem;
    }
    .kpi-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #1e40af;
      margin-bottom: 0.5rem;
    }
    .kpi-trend {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .trend-improving {
      color: #16a34a;
      font-weight: 600;
    }
    .trend-declining {
      color: #dc2626;
      font-weight: 600;
    }
    .trend-stable {
      color: #64748b;
      font-weight: 600;
    }
    .panel-interpretation {
      background: #eff6ff;
      padding: 1rem;
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
      margin-top: 1rem;
    }
    .panel-interpretation h4 {
      color: #1e40af;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }
    .panel-interpretation p {
      color: #475569;
      line-height: 1.6;
      margin: 0.5rem 0;
    }
    .stage-badge {
      display: inline-block;
      background: #dbeafe;
      color: #1e40af;
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .loading-message {
      text-align: center;
      padding: 3rem;
      color: #64748b;
      font-size: 1.1rem;
    }
    #stageDetection {
      background: #f0f9ff;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      color: #0369a1;
      font-weight: 500;
      display: none;
    }
  </style>
</head>
<body data-skoltyp="grundskola">
  <h1 id="pageTitle">Skolenhetsdashboard för rektorer</h1>

  <div class="kpi-selector">
    <div class="selector-row">
      <div class="selector-group">
        <label for="kommunSelect">Välj kommun:</label>
        <select id="kommunSelect"></select>
      </div>
      <div class="selector-group">
        <label for="skolenhetSelect">Välj skolenhet:</label>
        <select id="skolenhetSelect" disabled>
          <option value="">Hämtar skolenheter...</option>
        </select>
      </div>
    </div>
  </div>

  <a href="index.html" class="back-link">← Till startsidan</a>

  <div id="stageDetection"></div>

  <!-- Dashboard content rendered below -->

  <div id="dashboardContent">
    <!-- Förutsättningar Section -->
    <div class="dashboard-section">
      <h2>Förutsättningar</h2>
      <div class="kpi-grid" id="baselineKPIs"></div>
    </div>

    <!-- Resultat Section -->
    <div class="dashboard-section">
      <h2>Resultat</h2>
      <div class="kpi-grid" id="outcomeKPIs"></div>
    </div>

    <!-- SALSA Section -->
    <div class="dashboard-section">
      <h2>SALSA/Resultat givet förutsättningar</h2>
      <div class="kpi-grid" id="salsaKPIs"></div>
    </div>

    <!-- Trygghet Section -->
    <div class="dashboard-section">
      <h2>Trygghet åk 5</h2>
      <div class="kpi-grid" id="trygghetsKPIs"></div>
    </div>

    <!-- Automatisk Analys Section -->
    <div class="dashboard-section">
      <h2>Automatisk analys</h2>
      <div class="panel-interpretation" id="analysisText">
        <h4>Analys</h4>
        <p>Automatisk analys av nyckeltal visas här...</p>
      </div>
    </div>
  </div>

  <script type="module">
    import { ALLA_KOMMUNER } from './scripts/kommuner.js';
    import { SKOLENHET_SEARCH_API, SKOLENHET_DATA_BASE } from './scripts/constants.js';
    import { hamtaKoladaData } from './scripts/chartHelpers.js';

    // --- UI helpers ---
    function addKPICard(sectionId, kpi) {
      const section = document.getElementById(sectionId);
      const card = document.createElement('div');
      card.className = 'kpi-item';
      const label = document.createElement('div'); label.className = 'kpi-label'; label.textContent = kpi.label;
      const value = document.createElement('div'); value.className = 'kpi-value'; value.textContent = `${kpi.value ?? '—'} ${kpi.unit || ''}`.trim();
      const trend = document.createElement('div'); trend.className = `kpi-trend trend-${kpi.trendDirection}`; trend.innerHTML = `${kpi.trendArrow} ${kpi.trendText}`;
      const analysis = document.createElement('div'); analysis.className = 'kpi-analysis'; analysis.textContent = kpi.analysis;
      card.append(label, value, trend, analysis);
      section.appendChild(card);
    }
    function setLoading(sectionId, loading = true) {
      const el = document.getElementById(sectionId);
      if (el) el.innerHTML = loading ? '<div class="loading-message">Laddar...</div>' : '';
    }

    // --- Data helpers ---
    async function hamtaSkolenheterForKommun(kommunId) {
      let url = `${SKOLENHET_SEARCH_API}?municipality=${kommunId}&per_page=500`;
      const enheter = [];
      while (url) {
        const response = await fetch(url, { headers: { Accept: 'application/json' } });
        if (!response.ok) break;
        const data = await response.json();
        const resultat = data.results || data.values || [];
        resultat.forEach(enhet => {
          enheter.push({ id: enhet.id, title: enhet.title, type: (enhet.type || enhet.type_name || '').toLowerCase() });
        });
        url = data.next_page || data.next || null;
      }
      enheter.sort((a, b) => a.title.localeCompare(b.title, 'sv'));
      return enheter;
    }
    const kpiDefsBaseline = () => ([
      { id: 'N15807', label: 'Antal elever', unit: 'st' },
      { id: 'N15034', label: 'Elever per lärare (heltidstjänst), kommunal grundskola åk 1–9', unit: 'st' },
      { id: 'N15813', label: 'Andel legitimerade/behöriga lärare åk 1–9', unit: '%' }
    ]);
    const kpiDefsOutcome = () => ([
      // F-6
      { id: 'N15482', label: 'Åk 6: Engelska minst E', unit: '%' },
      { id: 'N15485', label: 'Åk 6: Matematik minst E', unit: '%' },
      { id: 'N15488', label: 'Åk 6: Svenska minst E', unit: '%' },
      { id: 'N15509', label: 'Åk 6: Betygspoäng i matematik', unit: 'poäng' },
      { id: 'N15510', label: 'Åk 6: Betygspoäng i svenska', unit: 'poäng' },
      // 7-9
      { id: 'N15419', label: 'Åk 9: Alla ämnen godkända', unit: '%' },
      { id: 'N15436', label: 'Åk 9: Behöriga till yrkesprogram', unit: '%' },
      { id: 'N15505', label: 'Åk 9: Meritvärde (17 ämnen)', unit: 'poäng' },
      { id: 'N15503', label: 'Åk 9: Betygspoäng matematik', unit: 'poäng' },
      { id: 'U15429', label: 'Åk 9: Högre slutbetyg än NP i matematik', unit: '%' },
      { id: 'U15430', label: 'Åk 9: Lägre slutbetyg än NP i matematik', unit: '%' }
    ]);
    const kpiDefsSalsa = () => ([
      { id: 'U15414', label: 'Åk 9: Avvikelse SALSA (%)', unit: 'p.p.' },
      { id: 'U15416', label: 'Åk 9: Meritvärde avvikelse (SALSA)', unit: 'poäng' }
    ]);
    const kpiDefsTrygghet = () => ([
      { id: 'N15613', label: 'Åk 5: Trygghet', unit: '%' },
      { id: 'N15603', label: 'Åk 5: Studiero', unit: '%' },
      { id: 'N15614', label: 'Åk 5: Vuxnas agerande mot kränkningar', unit: '%' }
    ]);

    function beraknaTrendtext(unit, values) {
      const serie = (values || []).filter(v => v != null);
      if (serie.length === 0) return { dir: 'stable', arrow: '→', text: 'Ingen data', analysis: 'Data saknas.', latest: null };
      const latest = serie[serie.length - 1];
      const prev = serie[serie.length - 2] ?? null;
      const idxMinus3 = serie.length - 4; const prev3 = idxMinus3 >= 0 ? serie[idxMinus3] : null;
      const unitSuffix = unit === '%' ? 'p.p.' : unit || '';
      let dir = 'stable', arrow = '→', text = 'Stabil';
      if (prev !== null) { const diff = latest - prev; if (diff > 0.05) { dir='improving'; arrow='↑'; } else if (diff < -0.05) { dir='declining'; arrow='↓'; } }
      if (prev3 !== null) { const diff3 = latest - prev3; const sign = diff3 > 0 ? '+' : ''; text = `${sign}${diff3.toFixed(1)} ${unitSuffix} på 3 år`; }
      else if (prev !== null) { const diff1 = latest - prev; const sign = diff1 > 0 ? '+' : ''; text = `${sign}${diff1.toFixed(1)} ${unitSuffix} på 1 år`; }
      else { text = 'Ingen trenddata'; }
      const analysis = dir === 'improving' ? 'Förbättring över tid.' : dir === 'declining' ? 'Försämring över tid.' : 'Stabil nivå.';
      return { dir, arrow, text, analysis, latest };
    }
    async function hamtaKpiCardData(ouId, def) {
      try {
        const data = await hamtaKoladaData(ouId, def.id, SKOLENHET_DATA_BASE);
        const hasAny = (data?.totalt || []).some(v => v != null);
        if (!hasAny) return { label: def.label, value: '—', unit: def.unit, trendDirection: 'stable', trendArrow: '→', trendText: 'Ingen data', analysis: 'Data saknas för denna indikator.' };
        const trend = beraknaTrendtext(def.unit, data.totalt);
        return { label: def.label, value: trend.latest != null ? (def.unit === '%' ? Number(trend.latest).toFixed(1) : trend.latest) : '—', unit: def.unit, trendDirection: trend.dir, trendArrow: trend.arrow, trendText: trend.text, analysis: trend.analysis };
      } catch (e) {
        console.warn('KPI fetch failed', def.id, e);
        return { label: def.label, value: '—', unit: def.unit, trendDirection: 'stable', trendArrow: '→', trendText: 'Kunde inte hämta', analysis: 'Kunde inte hämta data just nu.' };
      }
    }

    // --- Rendering ---
    async function renderSections(ouId) {
      // Baseline
      setLoading('baselineKPIs', true); document.getElementById('baselineKPIs').innerHTML = '';
      for (const def of kpiDefsBaseline()) { const card = await hamtaKpiCardData(ouId, def); addKPICard('baselineKPIs', card); }
      // Outcome (both F-6 and 7-9)
      setLoading('outcomeKPIs', true); document.getElementById('outcomeKPIs').innerHTML = '';
      for (const def of kpiDefsOutcome()) { const card = await hamtaKpiCardData(ouId, def); addKPICard('outcomeKPIs', card); }
      // SALSA
      setLoading('salsaKPIs', true); document.getElementById('salsaKPIs').innerHTML = '';
      for (const def of kpiDefsSalsa()) { const card = await hamtaKpiCardData(ouId, def); addKPICard('salsaKPIs', card); }
      // Trygghet
      setLoading('trygghetsKPIs', true); document.getElementById('trygghetsKPIs').innerHTML = '';
      for (const def of kpiDefsTrygghet()) { const card = await hamtaKpiCardData(ouId, def); addKPICard('trygghetsKPIs', card); }
    }

    // --- Selectors init ---
    const kommunSelect = document.getElementById('kommunSelect');
    const skolenhetSelect = document.getElementById('skolenhetSelect');
    function initKommuner(defaultId = '0684') {
      kommunSelect.innerHTML = '';
      ALLA_KOMMUNER.forEach(k => { const opt = document.createElement('option'); opt.value=k.id; opt.textContent=k.title; if (k.id===defaultId) opt.selected=true; kommunSelect.appendChild(opt); });
    }
    async function onKommunChange() {
      skolenhetSelect.disabled = true; skolenhetSelect.innerHTML = '<option>Hämtar skolenheter...</option>';
      const enheter = await hamtaSkolenheterForKommun(kommunSelect.value);
      skolenhetSelect.innerHTML = '';
      const def = document.createElement('option'); def.value=''; def.textContent='Välj skolenhet'; skolenhetSelect.appendChild(def);
      enheter.forEach(e => { const o=document.createElement('option'); o.value=e.id; o.textContent=e.title; skolenhetSelect.appendChild(o); });
      skolenhetSelect.disabled = false;
      // Clear sections when kommun changes
      ['baselineKPIs','outcomeKPIs','salsaKPIs','trygghetsKPIs'].forEach(id => document.getElementById(id).innerHTML='');
    }
    function onSkolenhetChange() {
      const ouId = skolenhetSelect.value; if (!ouId) return; renderSections(ouId);
    }
    kommunSelect.addEventListener('change', onKommunChange);
    skolenhetSelect.addEventListener('change', onSkolenhetChange);
    // Init
    initKommuner(); onKommunChange();
  </script>
</body>
</html>