{
	"version": "2.0.0",
	"tasks": [
		{
			"label": "Patch helpers and CSS for trend",
			"type": "shell",
			"command": "powershell",
			"args": [
				"-NoProfile",
				"-Command",
				"$ErrorActionPreference='Stop';\n# Patch CSS braces\n$c = Get-Content \"styles/skolenhetsdashboard.css\" -Raw;\n$c = $c -replace \"\\.kpi-trend-chart-title \\{([\\s\\S]*?)text-align: center;\\n\\.kpi-trend-chart-legend\",\".kpi-trend-chart-title {$1text-align: center;\\n}\\n.kpi-trend-chart-legend\";\n$c = $c -replace \"\\n\\}\\n\\n\\.kpi-trend-chart svg\", \"\\n\\n.kpi-trend-chart svg\";\nSet-Content \"styles/skolenhetsdashboard.css\" $c -Encoding UTF8;\n\n# Patch fetchAllMunicipalitiesForYear for robust parsing\n$f = Get-Content \"scripts/kommunbild/page.js\" -Raw;\n$old = @'\nasync function fetchAllMunicipalitiesForYear(kpiId, year) {\n  // Match older strategy: fetch all municipalities via /v3/data/kpi/<kpi>/municipality then filter client-side.\n  const url = `${KOLADA_DATA_BASE}/${encodeURIComponent(kpiId)}/municipality?per_page=500`;\n  console.log(`[kommunbild] fetching all municipalities (series): ${url}`);\n  const json = await fetchJson(url);\n\n  // Expected: { values: [ { kpi:\"...\", values:[ {municipality:\"0684\", values:[{period,values:[{gender,value}]}]} ] } ] }\n  const node = Array.isArray(json?.values) ? json.values[0]?.values : [];\n  const out = [];\n  for (const row of node || []) {\n    const municipality = row?.municipality ?? row?.municipality_id ?? null;\n    const periods = Array.isArray(row?.values) ? row.values : [];\n    const point = periods.find((p) => Number(p?.period) === Number(year)) ?? null;\n    const vals = Array.isArray(point?.values) ? point.values : [];\n    const total = vals.find((v) => v?.gender === \"T\") ?? vals[0];\n    out.push({ municipality, value: numberOrNull(total?.value) });\n  }\n  return out;\n}\n'@;\n$new = @'\nasync function fetchAllMunicipalitiesForYear(kpiId, year) {\n  const url = `${KOLADA_DATA_BASE}/${encodeURIComponent(kpiId)}/municipality?per_page=500`;\n  console.log(`[kommunbild] fetching all municipalities (series): ${url}`);\n  const json = await fetchJson(url);\n\n  const root = Array.isArray(json?.values) ? json.values : [];\n  let rows = [];\n  if (root.length && Array.isArray(root[0]?.values)) {\n    rows = root[0].values || [];\n  } else {\n    rows = root;\n  }\n  const out = [];\n  for (const row of rows) {\n    const municipality = row?.municipality ?? row?.municipality_id ?? null;\n    const periods = Array.isArray(row?.values) ? row.values : [];\n    const point = periods.find((p) => Number(p?.period) === Number(year));\n    if (!point) continue;\n    const vals = Array.isArray(point?.values) ? point.values : [];\n    const total = vals.find((v) => v?.gender === 'T') ?? vals[0];\n    out.push({ municipality, value: numberOrNull(total?.value) });\n  }\n  console.log(`[kommunbild] fetched ${out.length} muni values for ${kpiId} ${year}`);\n  return out;\n}\n'@;\n$f = $f -replace [regex]::Escape($old), [System.Text.RegularExpressions.Regex]::EscapeReplacement($new);\nSet-Content \"scripts/kommunbild/page.js\" $f -Encoding UTF8;\n\n\"Patched CSS and helper; done.\""
			]
		}
	]
}