<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Kolada – Kommun & Enhets‑KPI‑demo</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    select { margin: 10px 0; display: block; }
    canvas { max-width: 600px; }
  </style>
</head>
<body>
  <h1>Kolada – KPI för Sävsjö kommun & enhet</h1>

  <label for="kommunSelect">Välj kommun:</label>
  <select id="kommunSelect">
    <option value="0684">Sävsjö kommun</option>
  </select>

  <label for="enhetSelect">Välj enhets‑ID:</label>
  <select id="enhetSelect">
    <option value="V15E068401101">Vrigstad skola</option>
    <option value="V15E068400701">Vallsjöskolan</option>
    <option value="V15E068401501">Hofgårdsskolan</option>
  </select>

  <label for="kpiSelect">Välj KPI:</label>
  <select id="kpiSelect">
    <option value="N15508">Elever i åk 9 uppnått betygskriterierna i alla ämnen</option>
    <option value="N15543">Elever i åk 6 uppnått betygskriterierna i alla ämnen</option>
    <option value="N15814">Andel lärare med lärarlegitimation och behörighet i grundskolan åk 1–9</option>
    <option value="N01951">Andel lärare med pedagogisk högskoleexamen</option>
  </select>

  <canvas id="koladaChart"></canvas>

  <script>
    const BASE_URL = "https://api.kolada.se/v3";

    async function fetchDataForOu(kpiId, ouId, years) {
      const url = `${BASE_URL}/oudata/kpi/${kpiId}/ou/${ouId}?year=${years.join(',')}`;
      console.log("Fetch enhet URL:", url);
      const res = await fetch(url);
      const json = await res.json();
      console.log("Enhetsdata:", json);
      return json.values || [];
    }

    async function fetchDataForMunicipality(kpiId, municipalityId, years) {
      const url = `${BASE_URL}/data/kpi/${kpiId}/municipality/${municipalityId}?year=${years.join(',')}`;
      console.log("Fetch kommun URL:", url);
      const res = await fetch(url);
      const json = await res.json();
      console.log("Kommundata:", json);
      return json.values || [];
    }

    function buildChart(labels, values, labelText) {
      const ctx = document.getElementById('koladaChart').getContext('2d');
      if (window.myChart) window.myChart.destroy();
      window.myChart = new Chart(ctx, {
        type: 'line',
        data: { labels: labels, datasets: [{ label: labelText, data: values, borderColor: 'blue', fill: false }] },
        options: {
          responsive: true,
          plugins: { title: { display: true, text: 'Källa: Kolada' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    async function updateChart() {
      const municipalityId = document.getElementById('kommunSelect').value;
      const ouId = document.getElementById('enhetSelect').value;
      const kpiId = document.getElementById('kpiSelect').value;
      const years = [2021, 2022, 2023];

      try {
        // Försök hämta för enhet först
        let records = await fetchDataForOu(kpiId, ouId, years);
        let labelText = `Enhet ${ouId}`;

        if (!records.length) {
          console.warn("Ingen enhetsdata – fallback till kommun");
          // Hämta för kommunen
          records = await fetchDataForMunicipality(kpiId, municipalityId, years);
          labelText = `Kommun ${municipalityId}`;
        }

        if (!records.length) {
          alert("Ingen data för vald KPI och varken enhet eller kommun.");
          buildChart([], [], labelText);
          return;
        }

        const labels = records.map(r => r.period);
        const totals = records.map(r => {
          const totalObj = r.values.find(v => v.gender === "T");
          return totalObj ? totalObj.value : null;
        });

        buildChart(labels, totals, labelText);

      } catch(err) {
        console.error(err);
        alert("Fel vid hämtning av data: " + err.message);
      }
    }

    document.getElementById('kommunSelect').addEventListener('change', updateChart);
    document.getElementById('enhetSelect').addEventListener('change', updateChart);
    document.getElementById('kpiSelect').addEventListener('change', updateChart);

    updateChart();
  </script>
</body>
</html>
